# Чат

Обработка позволяет обмениваться сообщениями через HTML поле.

Используются:

* Общий не глобальный модуль на клиенте и сервере "Чат" с правом вызова сервера
* Общий не глобальный модуль на сервере с правом вызова сервера и привилигированный "ЧатНаСервере"
* Регистр сведений Чат с измерениями "Период, Публикатор, Участники, Тема" и ресурсом "Сообщение"
* Обработка "Чат"
* Строчный реквизит формы "ЧатHTML"

Обновление и обмен сообщениями происходит без перезагрузки HTML поля



##### Модуль формы:

```
#Область Чат

&НаКлиенте
Процедура ЧатHTMLДокументСформирован(Элемент)
	// Если мы выходим из формы и присвоили HTML = "<exit>" то пропускаем
	Если ЧатHTML = "<exit>" Тогда Возврат КонецЕсли;
	
	// Если ЧатHTML еще не заполнен - заполняем
	Если ПустаяСтрока(ЧатHTML) Тогда Чат.ЗаполнитьЧат(ЧатHTML); Возврат КонецЕсли;
	
	// Немного магии, чтоб смочь обращаться к глобальным переменным и функциям JS
	ОкноЧата	= Элементы.ЧатHTML.Документ.defaultView;	
	Если ОкноЧата = Неопределено Тогда ОкноЧата	= Элементы.ЧатHTML.Документ.parentWindow КонецЕсли;
	
	ОкноЧата.externalModule	= Чат;	// Позволяем JS чату вызывать общий модуль "Чат"
	ОкноЧата.getGroups();			// Говорим чату, что пора вывести список групп
КонецПроцедуры // ЧатHTMLДокументСформирован()

&НаКлиенте
Процедура ЗакрытьЧат()
	Сообщить("Закрываем чат в " + ЭтаФорма.ИмяФормы);
	Если Элементы.ЧатHTML.Документ = Неопределено Тогда Возврат КонецЕсли;
	ОкноЧата	= Элементы.ЧатHTML.Документ.defaultView;	
	Если ОкноЧата = Неопределено Тогда ОкноЧата	= Элементы.ЧатHTML.Документ.parentWindow КонецЕсли;
	//ОкноЧата.stopTimer();
	ОкноЧата.clearInterval(ОкноЧата.timer);
	ОкноЧата.timer			= Null;
	ОкноЧата.externalModule	= Null;
	//ОкноЧата.Close();
	ЧатHTML					= "<exit>";	
КонецПроцедуры // ЗакрытьЧат()

#КонецОбласти

```

##### Модуль управляемого приложения:

```
Процедура ПередЗавершениемРаботыСистемы(Отказ, ТекстПредупреждения)	
	// ...
	Оповестить("ЗакрытьЧат");	
	// ...	
КонецПроцедуры // ПередЗавершениемРаботыСистемы()

```



##### TODO:

1. Улучшить закрытие и сделать подключение и использование в 1 процедуру